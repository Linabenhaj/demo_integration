name: üîó RabbitMQ ‚ÜîÔ∏è Salesforce CI/CD Demo - MET ECHTE INTEGRATIE

on:
  push:
    branches: [main]
  workflow_dispatch:  # üëà Handmatig starten via GitHub UI

jobs:
  rabbitmq-integratie-demo:
    name: üêá Echte RabbitMQ ‚ÜîÔ∏è Salesforce Demo
    runs-on: ubuntu-latest
    
    steps:
    # STAP 1: Code ophalen
    - name: üì• 1. Code Repository Ophalen
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    # STAP 2: RabbitMQ Server Starten
    - name: üê≥ 2. Start RabbitMQ Container
      run: |
        echo "üöÄ RABBITMQ SERVER STARTEN..."
        docker run -d \
          --name rabbitmq-school-demo \
          -p 5672:5672 \
          -p 15672:15672 \
          --health-cmd="rabbitmq-diagnostics ping" \
          --health-interval=10s \
          --health-timeout=5s \
          --health-retries=5 \
          rabbitmq:3.13-management
        
        echo "‚è≥ Wachten tot RabbitMQ volledig opgestart is..."
        sleep 15
        echo "‚úÖ RabbitMQ server is klaar!"
        echo "   ‚Ä¢ AMQP poort: 5672"
        echo "   ‚Ä¢ Web interface: 15672"
    
    # STAP 3: STUUR ECHT BERICHT MET CURL
    - name: üì® 3. Stuur "Hallo" Bericht naar RabbitMQ
      run: |
        echo "üì§ ECHT BERICHT VERSTUREN..."
        echo "=============================="
        
        # EERST: Maak een queue aan (optioneel maar netjes)
        curl -u guest:guest -X PUT \
          -H "Content-Type: application/json" \
          http://localhost:15672/api/queues/%2F/school.demo \
          -d '{
            "auto_delete": false,
            "durable": true,
            "arguments": {}
          }'
        
        echo "‚úÖ Queue 'school.demo' aangemaakt"
        
        # NU: Stuur het echte bericht
        echo ""
        echo "üì® STUUR BERICHT NAAR RABBITMQ:"
        
        curl -u guest:guest -X POST \
          -H "Content-Type: application/json" \
          http://localhost:15672/api/exchanges/%2F/amq.default/publish \
          -d '{
            "properties": {
              "content_type": "text/plain",
              "delivery_mode": 2
            },
            "routing_key": "school.demo",
            "payload": "HALLO vanuit CI/CD Pipeline! Dit is een echt RabbitMQ bericht.",
            "payload_encoding": "string"
          }'
        
        echo ""
        echo "‚úÖ BERICHT SUCCESVOL VERSTUURD!"
        echo "   Queue: school.demo"
        echo "   Bericht: 'HALLO vanuit CI/CD Pipeline! Dit is een echt RabbitMQ bericht.'"
    
    # STAP 4: Controleer of bericht is aangekomen
    - name: üîç 4. Controleer RabbitMQ Status
      run: |
        echo "üìä RABBITMQ STATUS CONTROLEREN..."
        echo "================================"
        
        # Toon alle queues
        echo ""
        echo "üìã BESCHIKBARE QUEUES:"
        curl -s -u guest:guest http://localhost:15672/api/queues | \
          jq -r '.[] | "‚Ä¢ \(.name) (\(.messages) berichten)"' || \
          echo "Gebruik fallback als jq niet werkt..."
        
        # Specifieke queue details
        echo ""
        echo "üîç DETAILS VAN 'school.demo' QUEUE:"
        curl -s -u guest:guest http://localhost:15672/api/queues/%2F/school.demo | \
          python3 -c "
import json, sys
try:
    data = json.load(sys.stdin)
    print(f'‚Ä¢ Queue: {data[\"name\"]}')
    print(f'‚Ä¢ Aantal berichten: {data[\"messages\"]}')
    print(f'‚Ä¢ Consumers: {data[\"consumers\"]}')
    print(f'‚Ä¢ Status: {data[\"state\"]}')
except:
    print('Queue details ophalen...')
"
        
        # RabbitMQ management interface info
        echo ""
        echo "üåê RABBITMQ MANAGEMENT CONSOLE:"
        echo "================================"
        echo "URL: http://localhost:15672"
        echo "Gebruiker: guest"
        echo "Wachtwoord: guest"
        echo ""
        echo "‚ö†Ô∏è  Opmerking: Deze URL is alleen lokaal beschikbaar tijdens de workflow run."
        echo "   In productie zou dit een publieke URL zijn."
    
    # STAP 5: Demo conclusie
    - name: üéì 5. Demo Uitleg en Conclusie
      run: |
        echo ""
        echo "üéØ DEMO CONCLUSIE"
        echo "================="
        echo ""
        echo "‚úÖ WAT WE NET GEDAAN HEBBEN:"
        echo "1. üê≥ RabbitMQ server gestart in Docker"
        echo "2. üì® Echt bericht verstuurd via curl"
        echo "3. üîç Status gecontroleerd via RabbitMQ API"
        echo ""
        echo "üí° VOOR JULLIE PROJECT:"
        echo "‚Ä¢ Dit 'HALLO' bericht zou Salesforce data bevatten"
        echo "‚Ä¢ Bijvoorbeeld:"
        echo "  {"
        echo '    "action": "create_opportunity",'
        echo '    "amount": 1500,'
        echo '    "customer": "Demo Klant"'
        echo "  }"
        echo ""
        echo "üîÑ VOLGENDE STAP IN INTEGRATIE:"
        echo "1. Salesforce haalt berichten op uit RabbitMQ"
        echo "2. Salesforce verwerkt de data"
        echo "3. Salesforce stuurt bevestiging terug"
        echo ""
        echo "üöÄ DEMO GESLAAGD!"